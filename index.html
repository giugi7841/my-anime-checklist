<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Anime Checklist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background: #111827;
            --surface: #1f2937;
            --primary: #3b82f6;
            --on-surface: #d1d5db;
            --on-surface-secondary: #9ca3af;
        }
        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--on-surface);
        }
        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--surface); }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px;}
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        input:-webkit-autofill,
        input:-webkit-autofill:hover,
        input:-webkit-autofill:focus,
        input:-webkit-autofill:active {
            -webkit-text-fill-color: #ffffff !important;
            -webkit-box-shadow: 0 0 0 30px var(--surface) inset !important;
            box-shadow: 0 0 0 30px var(--surface) inset !important;
        }
        
        #search-input {
            background-color: var(--surface) !important;
            color: var(--on-surface) !important;
        }
        #search-input::placeholder {
            color: var(--on-surface-secondary);
        }

        .progress-bar {
            transition: width 0.5s ease-in-out;
        }

        .overview-truncated {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Login View -->
    <div id="login-view" class="fixed inset-0 flex items-center justify-center hidden p-4">
        <div class="w-full max-w-sm text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">My Anime Checklist ğŸ“</h1>
            <p class="text-gray-400 mb-8">ë‹¹ì‹ ì˜ ì• ë‹ˆ ì—¬ì •ì„ ê¸°ë¡í•˜ê³  ì„±ì¥ì‹œí‚¤ì„¸ìš”.</p>
            <div class="space-y-4">
                <button id="login-btn" class="w-full bg-white text-gray-800 font-semibold py-3 px-6 rounded-lg flex items-center justify-center shadow-lg hover:bg-gray-200 transition">
                    <svg class="w-6 h-6 mr-3" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                    Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
                </button>
                <p class="text-xs text-gray-500">ëª¨ë“  ê¸°ê¸°ì—ì„œ ë°ì´í„°ë¥¼ ë™ê¸°í™”í•˜ì„¸ìš”.</p>
                <button id="guest-login-btn" class="w-full bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg hover:bg-gray-700 transition">
                    ê²ŒìŠ¤íŠ¸ë¡œ ê³„ì†í•˜ê¸°
                </button>
                 <p class="text-xs text-gray-500">ê¸°ë¡ì€ í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ ê¸°ê¸°ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>

    <!-- Main App View -->
    <div id="app" class="max-w-7xl mx-auto p-4 md:p-6 lg:p-8 hidden">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-xl md:text-2xl font-bold text-white">My Anime Checklist ğŸ“</h1>
            <div id="user-profile" class="flex items-center space-x-3 hidden">
                <!-- Guest / User Info -->
            </div>
        </header>

        <!-- Achievements -->
        <div id="achievement-container" class="bg-surface rounded-lg p-4 mb-6 shadow-lg">
             <div id="achievement-header" class="flex justify-between items-center">
                <h2 class="text-lg font-bold text-white">ì—…ì  ë‹¬ì„± ğŸ†</h2>
            </div>
            <div id="achievement-details" class="mt-4"></div>
        </div>
        
        <!-- Search and Add Section -->
        <div class="mb-6 relative">
            <input type="text" id="search-input" placeholder="ì• ë‹ˆë©”ì´ì…˜ ì œëª©ìœ¼ë¡œ ê²€ìƒ‰ (ì˜ˆ: ì£¼ìˆ íšŒì „)" class="w-full border border-gray-600 rounded-lg py-3 px-4 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary">
            <div id="search-results" class="absolute z-10 w-full mt-2 bg-[#2a374a] rounded-lg shadow-xl max-h-80 overflow-y-auto hidden"></div>
        </div>

        <!-- My List Section -->
        <div>
            <div class="flex border-b border-gray-700 mb-4">
                <button data-status="all" class="list-tab py-2 px-4 text-sm font-medium text-white border-b-2 border-primary focus:outline-none">ì „ì²´</button>
                <button data-status="watching" class="list-tab py-2 px-4 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent focus:outline-none">ì‹œì²­ ì¤‘</button>
                <button data-status="completed" class="list-tab py-2 px-4 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent focus:outline-none">ì™„ë£Œ</button>
                <button data-status="planned" class="list-tab py-2 px-4 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent focus:outline-none">ì‹œì²­ ì˜ˆì •</button>
                <button data-status="dropped" class="list-tab py-2 px-4 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent focus:outline-none">ì¤‘ë‹¨</button>
            </div>
            <div id="my-list-container" class="space-y-3"></div>
        </div>
    </div>

    <!-- Unified Info/Edit Modal -->
    <div id="info-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-surface rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div id="info-modal-content" class="p-6 flex-grow overflow-y-auto">
                 <div id="info-loader" class="text-center p-8">
                    <p class="text-white">ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
                <div id="info-content-wrapper" class="hidden md:grid md:grid-cols-3 md:gap-8">
                    <div class="md:col-span-2">
                        <h3 class="text-2xl font-bold mb-4 text-white" id="info-title"></h3>
                        <div class="flex flex-col sm:flex-row">
                             <img id="info-poster" src="" alt="Anime Poster" class="w-32 h-auto sm:w-40 flex-shrink-0 mr-6 mb-4 rounded-md">
                             <div>
                                 <p id="info-overview" class="text-gray-300 leading-relaxed"></p>
                                 <button id="overview-toggle" class="text-primary hover:underline mt-2 text-sm hidden">ë”ë³´ê¸°...</button>
                             </div>
                        </div>
                    </div>
                    <div class="md:col-span-1 mt-6 md:mt-0">
                         <div class="space-y-4 bg-gray-900/50 p-4 rounded-lg">
                            <div>
                                <label for="modal-status" class="block text-sm font-medium text-gray-400 mb-1">ì‹œì²­ ìƒíƒœ</label>
                                <select id="modal-status" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-primary"></select>
                            </div>
                            <div>
                                <label for="modal-score" class="block text-sm font-medium text-gray-400 mb-1">ì ìˆ˜</label>
                                <select id="modal-score" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-primary"></select>
                            </div>
                         </div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-gray-900/50 flex justify-between items-center flex-shrink-0">
                 <button id="modal-delete" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-md transition text-sm">ë¦¬ìŠ¤íŠ¸ì—ì„œ ì‚­ì œ</button>
                 <div class="space-x-3">
                    <button id="modal-cancel" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-md transition">ì·¨ì†Œ</button>
                    <button id="modal-save" class="px-4 py-2 bg-primary hover:bg-blue-700 text-white font-semibold rounded-md transition">ì €ì¥</button>
                 </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        document.addEventListener('DOMContentLoaded', () => {
            const TMDB_API_KEY = '9a5e26536e343678fc2a6147946e748a'; 
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined'
                ? JSON.parse(__firebase_config) : { apiKey: "INVALID_API_KEY", authDomain: "...", projectId: "...", appId: "..." };

            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            let userId = null;
            let userList = {};
            let unsubscribe = null; 
            let currentEditingId = null;
            let currentFilter = 'all';

            const loginView = document.getElementById('login-view');
            const appView = document.getElementById('app');
            const loginBtn = document.getElementById('login-btn');
            const guestLoginBtn = document.getElementById('guest-login-btn');
            const userProfile = document.getElementById('user-profile');
            const searchInput = document.getElementById('search-input');
            const searchResultsContainer = document.getElementById('search-results');
            const myListContainer = document.getElementById('my-list-container');
            const tabs = document.querySelectorAll('.list-tab');
            const infoModal = document.getElementById('info-modal');
            const modalStatus = document.getElementById('modal-status');
            const modalScore = document.getElementById('modal-score');
            const overviewEl = document.getElementById('info-overview');
            const overviewToggleBtn = document.getElementById('overview-toggle');
            
            const achievements = [
                { level: 1, count: 1, name: "ìƒˆì‹¹", emoji: "ğŸŒ±" },
                { level: 2, count: 30, name: "ì• ë‹ˆ ì• í˜¸ê°€", emoji: "ğŸ§¡" },
                { level: 3, count: 100, name: "ì• ë‹ˆ ì „ë¬¸ê°€", emoji: "ğŸ“" },
                { level: 4, count: 300, name: "ì˜¤íƒ€ì¿ ", emoji: "ğŸ†" },
                { level: 5, count: 500, name: "ë§ë ¹", emoji: "ğŸ‘»" }
            ];

            onAuthStateChanged(auth, user => {
                if (user) {
                    userId = user.uid;
                    loginView.classList.add('hidden');
                    appView.classList.remove('hidden');
                    userProfile.classList.remove('hidden');
                    
                    if (user.isAnonymous) {
                        userProfile.innerHTML = `
                            <span class="text-sm md:text-base text-yellow-400 font-semibold">ê²ŒìŠ¤íŠ¸ ëª¨ë“œ</span>
                            <button id="logout-btn" class="text-xs bg-gray-600 hover:bg-gray-700 text-white font-semibold py-1 px-3 rounded-md transition">ë‚˜ê°€ê¸°</button>
                        `;
                    } else {
                        userProfile.innerHTML = `
                            <img id="user-avatar" class="w-8 h-8 md:w-10 md:h-10 rounded-full" src="${user.photoURL}" alt="User Avatar">
                            <span id="user-name" class="text-sm md:text-base text-white font-semibold hidden sm:inline">${user.displayName}</span>
                            <button id="logout-btn" class="text-xs bg-gray-600 hover:bg-gray-700 text-white font-semibold py-1 px-3 rounded-md transition">ë¡œê·¸ì•„ì›ƒ</button>
                        `;
                    }
                    document.getElementById('logout-btn').addEventListener('click', logout);
                    loadUserList();
                } else {
                    userId = null;
                    userList = {};
                    if (unsubscribe) unsubscribe();
                    renderMyList(); 
                    updateAchievements();
                    loginView.classList.remove('hidden');
                    appView.classList.add('hidden');
                    userProfile.classList.add('hidden');
                }
            });

            async function signInWithGoogle() {
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error("Google sign-in failed:", error);
                    if (error.code === 'auth/unauthorized-domain') {
                        const domain = window.location.hostname;
                        alert(`ë¡œê·¸ì¸ ì‹¤íŒ¨(auth/unauthorized-domain): í˜„ì¬ ì•±ì˜ ì£¼ì†Œê°€ Firebaseì— ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\nFirebase ì½˜ì†”ì˜ [Authentication > Settings > ìŠ¹ì¸ëœ ë„ë©”ì¸] ëª©ë¡ì— í˜„ì¬ ë¸Œë¼ìš°ì €ì˜ ë„ë©”ì¸ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”: ${domain}`);
                    } else {
                        alert("ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
                    }
                }
            }
            
            async function signInAsGuest() {
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Guest sign-in failed:", error);
                    alert("ê²ŒìŠ¤íŠ¸ ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                }
            }

            async function logout() {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Sign-out failed:", error);
                }
            }
            
            function loadUserList() {
                 if (!userId) return;
                if (unsubscribe) unsubscribe();
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/animeChecklist`, "data");
                unsubscribe = onSnapshot(userDocRef, (doc) => {
                    userList = doc.exists() ? doc.data() : {};
                    renderMyList();
                    updateAchievements();
                });
            }
            
            async function saveUserList() {
                if (!userId) return;
                try {
                    const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/animeChecklist`, "data");
                    await setDoc(userDocRef, userList);
                } catch (error) {
                    console.error("Error saving user list: ", error);
                }
            }
            
            function debounce(func, delay) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => func.apply(this, a), delay); }; }
            const debouncedSearch = debounce(handleSearchInput, 300);
            
            async function handleSearchInput() {
                const searchTerm = searchInput.value.trim();
                if (searchTerm.length < 2) { searchResultsContainer.classList.add('hidden'); return; }
                searchResultsContainer.innerHTML = `<div class="p-4 text-center text-gray-400">ê²€ìƒ‰ ì¤‘...</div>`;
                searchResultsContainer.classList.remove('hidden');
                try {
                    const url = `https://api.themoviedb.org/3/search/tv?api_key=${TMDB_API_KEY}&language=ko-KR&query=${encodeURIComponent(searchTerm)}&include_adult=false`;
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Network response');
                    const data = await response.json();
                    const animeResults = data.results.filter(item => item.origin_country.includes('JP') || (item.genre_ids && item.genre_ids.includes(16)));
                    renderSearchResults(animeResults);
                } catch (error) {
                    console.error("Search failed:", error);
                    searchResultsContainer.innerHTML = `<div class="p-4 text-center text-red-400">ê²€ìƒ‰ ì‹¤íŒ¨</div>`;
                }
            }

            function renderSearchResults(results) {
                if (results.length === 0) { searchResultsContainer.innerHTML = `<div class="p-4 text-center text-gray-400">ê²°ê³¼ ì—†ìŒ</div>`; return; }
                searchResultsContainer.innerHTML = results.map(anime => {
                    const year = anime.first_air_date ? anime.first_air_date.split('-')[0] : 'N/A';
                    const posterPath = anime.poster_path ? `https://image.tmdb.org/t/p/w92${anime.poster_path}` : 'https://placehold.co/45x68/374151/9ca3af?text=N/A';
                    return `<div class="flex items-center p-3 hover:bg-gray-700 cursor-pointer" data-anime-id="${anime.id}" data-anime-title="${encodeURIComponent(anime.name)}" data-anime-year="${year}" data-poster-url="${posterPath}"><img src="${posterPath}" alt="${anime.name}" class="w-10 h-15 object-cover rounded-sm mr-4"><div><p class="font-semibold text-white">${anime.name}</p><p class="text-sm text-gray-300">${year}</p></div></div>`;
                }).join('');
            }
            
            const statusColors = { watching: { border: 'border-blue-500', bg: 'bg-blue-900/30', text: 'text-blue-400' }, completed: { border: 'border-green-500', bg: 'bg-green-900/30', text: 'text-green-400' }, planned: { border: 'border-yellow-500', bg: 'bg-yellow-900/30', text: 'text-yellow-400' }, dropped: { border: 'border-red-500', bg: 'bg-red-900/30', text: 'text-red-400' }, default: { border: 'border-gray-600', bg: 'bg-surface', text: 'text-gray-500' } };
            function getFilterName(status) { switch (status) { case 'watching': return 'ì‹œì²­ ì¤‘'; case 'completed': return 'ì™„ë£Œ'; case 'planned': return 'ì‹œì²­ ì˜ˆì •'; case 'dropped': return 'ì¤‘ë‹¨'; case 'all': return 'ì „ì²´'; default: return ''; } }
            function addAnimeToList(animeData) { const animeId = animeData.id; if (!animeId) { console.error("Invalid anime data provided:", animeData); return; } if (userList[animeId]) { alert('ì´ë¯¸ ë¦¬ìŠ¤íŠ¸ì— ìˆìŠµë‹ˆë‹¤.'); return; } userList[animeId] = { id: animeId, title: decodeURIComponent(animeData.title), year: animeData.year, posterUrl: animeData.posterUrl, status: 'planned', score: 0, addedAt: Date.now() }; renderMyList(); updateAchievements(); saveUserList(); searchInput.value = ''; searchResultsContainer.classList.add('hidden'); }
            function renderMyList() { if (!myListContainer) return; const filteredList = Object.entries(userList).filter(([id, data]) => currentFilter === 'all' || data.status === currentFilter).sort(([, a], [, b]) => b.addedAt - a.addedAt); if (filteredList.length === 0) { myListContainer.innerHTML = `<div class="text-center py-10 text-gray-500"><p>${currentFilter === 'all' ? 'ë¦¬ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.' : `'${getFilterName(currentFilter)}' ìƒíƒœì˜ ì• ë‹ˆê°€ ì—†ìŠµë‹ˆë‹¤.`}</p><p class="text-sm mt-2">ê²€ìƒ‰ì°½ì—ì„œ ì¶”ê°€í•´ë³´ì„¸ìš”!</p></div>`; return; } myListContainer.innerHTML = filteredList.map(([id, data]) => { const colors = statusColors[data.status] || statusColors.default; return `<div id="item-${id}" class="p-3 rounded-lg flex items-center space-x-4 shadow-md border-l-4 cursor-pointer anime-item ${colors.border} ${colors.bg}" data-anime-id="${id}"><img src="${data.posterUrl}" onerror="this.src='https://placehold.co/45x68/374151/9ca3af?text=N/A'" alt="${data.title}" class="w-10 h-15 object-cover rounded-sm flex-shrink-0"><div class="flex-grow min-w-0"><p class="font-bold text-white truncate">${data.title}</p><p class="text-sm text-gray-400">${data.year}</p></div><div class="text-right flex-shrink-0"><p class="font-semibold text-lg ${data.score > 0 ? 'text-primary' : 'text-gray-500'}">${data.score > 0 ? data.score : 'N/A'}</p><p class="text-xs font-semibold ${colors.text}">${getFilterName(data.status)}</p></div></div>`; }).join(''); }
            function updateAchievements() { const achievementDetails = document.getElementById('achievement-details'); if (!achievementDetails) return; const completedCount = Object.values(userList).filter(item => item.status === 'completed').length; let currentAchievement = null; for (let i = achievements.length - 1; i >= 0; i--) { if (completedCount >= achievements[i].count) { currentAchievement = achievements[i]; break; } } const nextGoal = achievements.find(ach => completedCount < ach.count); const displayAchievement = currentAchievement || achievements[0]; let progressText; let progressTarget; if (nextGoal) { progressText = `ë‹¤ìŒ: ${nextGoal.name} (${completedCount}/${nextGoal.count})`; progressTarget = nextGoal.count; } else { progressText = 'ìµœê³  ë“±ê¸‰ ë‹¬ì„±!'; progressTarget = currentAchievement ? currentAchievement.count : 0; } const progressWidth = (progressTarget > 0) ? Math.min(100, (completedCount / progressTarget) * 100) : 0; achievementDetails.innerHTML = `<div class="flex items-center"><div class="text-3xl mr-4">${displayAchievement.emoji}</div><div class="flex-grow"><div class="flex justify-between items-baseline"><p class="font-bold text-white">${displayAchievement.name}</p><p class="text-sm text-gray-400">${progressText}</p></div><div class="w-full bg-gray-700 rounded-full h-2 mt-1"><div class="progress-bar bg-primary h-2 rounded-full" style="width: ${progressWidth}%"></div></div></div></div>`; }
            async function openInfoModal(animeId) { currentEditingId = animeId; const anime = userList[animeId]; if (!anime) return; const infoContentWrapper = document.getElementById('info-content-wrapper'); const infoLoader = document.getElementById('info-loader'); infoLoader.classList.remove('hidden'); infoContentWrapper.classList.add('hidden'); infoModal.classList.remove('hidden'); modalStatus.innerHTML = `<option value="watching">ì‹œì²­ ì¤‘</option><option value="completed">ì™„ë£Œ</option><option value="planned">ì‹œì²­ ì˜ˆì •</option><option value="dropped">ì¤‘ë‹¨</option>`; modalScore.innerHTML = `<option value="0">ë¯¸ì„ íƒ</option>${[10,9,8,7,6,5,4,3,2,1].map(s => `<option value="${s}">${s}</option>`).join('')}`; modalStatus.value = anime.status; modalScore.value = anime.score; try { const url = `https://api.themoviedb.org/3/tv/${animeId}?api_key=${TMDB_API_KEY}&language=ko-KR`; const response = await fetch(url); if (!response.ok) throw new Error('Failed to fetch details'); const data = await response.json(); document.getElementById('info-title').textContent = data.name; const posterPath = data.poster_path ? `https://image.tmdb.org/t/p/w300${data.poster_path}` : 'https://placehold.co/300x450/374151/9ca3af?text=N/A'; document.getElementById('info-poster').src = posterPath; const overview = data.overview || 'ì¤„ê±°ë¦¬ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'; overviewEl.textContent = overview; setTimeout(() => { overviewEl.classList.add('overview-truncated'); if (overviewEl.scrollHeight > overviewEl.clientHeight) { overviewToggleBtn.classList.remove('hidden'); overviewToggleBtn.textContent = 'ë”ë³´ê¸°...'; } else { overviewToggleBtn.classList.add('hidden'); } }, 100); infoLoader.classList.add('hidden'); infoContentWrapper.classList.remove('hidden'); } catch (error) { console.error("Failed to fetch details:", error); document.getElementById('info-modal-content').innerHTML = `<p class="text-red-400 text-center">ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨.</p>`; } }
            function closeInfoModal() { infoModal.classList.add('hidden'); }
            function saveChanges() { if (!currentEditingId || !userList[currentEditingId]) return; const button = document.getElementById('modal-save'); button.disabled = true; button.textContent = 'ì €ì¥ ì¤‘...'; userList[currentEditingId].status = modalStatus.value; userList[currentEditingId].score = parseInt(modalScore.value, 10); renderMyList(); updateAchievements(); closeInfoModal(); saveUserList().finally(() => { button.disabled = false; button.textContent = 'ì €ì¥'; }); }
            function deleteItem() { if (!currentEditingId || !userList[currentEditingId]) return; delete userList[currentEditingId]; renderMyList(); updateAchievements(); closeInfoModal(); saveUserList(); }
            
            searchInput.addEventListener('input', debouncedSearch);
            searchResultsContainer.addEventListener('click', e => { 
                const item = e.target.closest('[data-anime-id]'); 
                if (item) {
                     addAnimeToList({
                         id: item.getAttribute('data-anime-id'),
                         title: item.getAttribute('data-anime-title'),
                         year: item.getAttribute('data-anime-year'),
                         posterUrl: item.getAttribute('data-poster-url')
                     });
                }
            });
            myListContainer.addEventListener('click', e => { 
                const item = e.target.closest('.anime-item'); 
                if (item) {
                    openInfoModal(item.getAttribute('data-anime-id'));
                }
            });
            overviewToggleBtn.addEventListener('click', () => { overviewEl.classList.toggle('overview-truncated'); overviewToggleBtn.textContent = overviewEl.classList.contains('overview-truncated') ? 'ë”ë³´ê¸°...' : 'ì ‘ê¸°'; });
            document.getElementById('modal-save').addEventListener('click', saveChanges);
            document.getElementById('modal-cancel').addEventListener('click', closeInfoModal);
            document.getElementById('modal-delete').addEventListener('click', deleteItem);
            tabs.forEach(tab => { tab.addEventListener('click', e => { tabs.forEach(t => t.classList.replace('text-white', 'text-gray-400') || t.classList.replace('border-primary', 'border-transparent')); e.target.classList.replace('text-gray-400', 'text-white'); e.target.classList.replace('border-transparent', 'border-primary'); currentFilter = e.target.dataset.status; renderMyList(); }); });
        });
    </script>
</body>
</html>

