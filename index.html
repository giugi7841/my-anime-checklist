<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Anime Checklist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background: #111827;
            --surface: #1f2937;
            --primary: #3b82f6;
            --on-surface: #d1d5db;
            --on-surface-secondary: #9ca3af;
        }
        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--on-surface);
        }
        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--surface); }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px;}
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        input:-webkit-autofill,
        input:-webkit-autofill:hover,
        input:-webkit-autofill:focus,
        input:-webkit-autofill:active {
            -webkit-text-fill-color: #ffffff !important;
            -webkit-box-shadow: 0 0 0 30px var(--surface) inset !important;
            box-shadow: 0 0 0 30px var(--surface) inset !important;
        }
        
        #search-input, .auth-input {
            background-color: var(--surface) !important;
            color: var(--on-surface) !important;
        }
        #search-input::placeholder, .auth-input::placeholder {
            color: var(--on-surface-secondary);
        }

        .progress-bar {
            transition: width 0.5s ease-in-out;
        }

        .overview-truncated {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Auth View -->
    <div id="auth-view" class="fixed inset-0 flex items-center justify-center hidden p-4">
        <div class="w-full max-w-sm text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">My Anime Checklist ğŸ“</h1>
            <p class="text-gray-400 mb-8">ë‹¹ì‹ ì˜ ì• ë‹ˆ ì—¬ì •ì„ ê¸°ë¡í•˜ê³  ì„±ì¥ì‹œí‚¤ì„¸ìš”.</p>
            
            <!-- Login Form -->
            <form id="login-form" class="space-y-4">
                <input id="login-email" type="email" placeholder="ì´ë©”ì¼" class="auth-input w-full px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                <input id="login-password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="auth-input w-full px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                <button type="submit" class="w-full bg-primary text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 transition">ë¡œê·¸ì¸</button>
                <p class="text-center text-sm text-red-400 hidden" id="login-error"></p>
                <p class="text-center text-sm text-gray-400">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <a href="#" id="show-signup" class="font-semibold text-primary hover:underline">íšŒì›ê°€ì…</a></p>
            </form>

            <!-- Signup Form -->
            <form id="signup-form" class="space-y-4 hidden">
                <input id="signup-email" type="email" placeholder="ì´ë©”ì¼" class="auth-input w-full px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                <input id="signup-password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)" class="auth-input w-full px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                <input id="signup-password-confirm" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" class="auth-input w-full px-4 py-2 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                <button type="submit" class="w-full bg-primary text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 transition">íšŒì›ê°€ì…</button>
                <p class="text-center text-sm text-red-400 hidden" id="signup-error"></p>
                <p class="text-center text-sm text-gray-400">ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <a href="#" id="show-login" class="font-semibold text-primary hover:underline">ë¡œê·¸ì¸</a></p>
            </form>

            <div class="relative flex py-5 items-center">
                <div class="flex-grow border-t border-gray-600"></div>
                <span class="flex-shrink mx-4 text-gray-400 text-sm">ë˜ëŠ”</span>
                <div class="flex-grow border-t border-gray-600"></div>
            </div>

            <div class="space-y-4">
                <button id="google-login-btn" class="w-full bg-white text-gray-800 font-semibold py-3 px-6 rounded-lg flex items-center justify-center shadow-lg hover:bg-gray-200 transition">
                    <svg class="w-6 h-6 mr-3" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                    Google ê³„ì •ìœ¼ë¡œ ê³„ì†í•˜ê¸°
                </button>
                <a href="#" id="guest-login-btn" class="text-sm text-gray-400 hover:text-white">ê²ŒìŠ¤íŠ¸ë¡œ ë‘˜ëŸ¬ë³´ê¸°</a>
            </div>
        </div>
    </div>

    <!-- Main App View -->
    <div id="app" class="max-w-7xl mx-auto p-4 md:p-6 lg:p-8 hidden">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-xl md:text-2xl font-bold text-white">My Anime Checklist ğŸ“</h1>
            <div id="user-profile" class="flex items-center space-x-3 hidden">
                <!-- User Info -->
            </div>
        </header>

        <!-- Achievements -->
        <div id="achievement-container" class="bg-surface rounded-lg p-4 mb-6 shadow-lg">
             <div id="achievement-header" class="flex justify-between items-center">
                <h2 class="text-lg font-bold text-white">ì—…ì  ë‹¬ì„± ğŸ†</h2>
            </div>
            <div id="achievement-details" class="mt-4"></div>
        </div>
        
        <!-- Search and Add Section -->
        <div class="mb-6 relative">
            <input type="text" id="search-input" placeholder="ì• ë‹ˆë©”ì´ì…˜ ì œëª©ìœ¼ë¡œ ê²€ìƒ‰ (ì˜ˆ: ì£¼ìˆ íšŒì „)" class="w-full border border-gray-600 rounded-lg py-3 px-4 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary">
            <div id="search-results" class="absolute z-10 w-full mt-2 bg-[#2a374a] rounded-lg shadow-xl max-h-80 overflow-y-auto hidden"></div>
        </div>

        <!-- My List Section -->
        <div>
            <div class="flex border-b border-gray-700 mb-4">
                <button data-status="all" class="list-tab py-2 px-4 text-sm font-medium text-white border-b-2 border-primary focus:outline-none">ì „ì²´</button>
                <button data-status="watching" class="list-tab py-2 px-4 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent focus:outline-none">ì‹œì²­ ì¤‘</button>
                <button data-status="completed" class="list-tab py-2 px-4 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent focus:outline-none">ì™„ë£Œ</button>
                <button data-status="planned" class="list-tab py-2 px-4 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent focus:outline-none">ì‹œì²­ ì˜ˆì •</button>
                <button data-status="dropped" class="list-tab py-2 px-4 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent focus:outline-none">ì¤‘ë‹¨</button>
            </div>
            <div id="my-list-container" class="space-y-3"></div>
        </div>
    </div>

    <!-- Unified Info/Edit Modal -->
    <div id="info-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-surface rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div id="info-modal-content" class="p-6 flex-grow overflow-y-auto">
                 <div id="info-loader" class="text-center p-8">
                    <p class="text-white">ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
                <div id="info-content-wrapper" class="hidden md:grid md:grid-cols-3 md:gap-8">
                    <div class="md:col-span-2">
                        <h3 class="text-2xl font-bold mb-4 text-white" id="info-title"></h3>
                        <div class="flex flex-col sm:flex-row">
                             <img id="info-poster" src="" alt="Anime Poster" class="w-32 h-auto sm:w-40 flex-shrink-0 mr-6 mb-4 rounded-md">
                             <div>
                                 <p id="info-overview" class="text-gray-300 leading-relaxed"></p>
                                 <button id="overview-toggle" class="text-primary hover:underline mt-2 text-sm hidden">ë”ë³´ê¸°...</button>
                             </div>
                        </div>
                    </div>
                    <div class="md:col-span-1 mt-6 md:mt-0">
                         <div class="space-y-4 bg-gray-900/50 p-4 rounded-lg">
                            <div>
                                <label for="modal-status" class="block text-sm font-medium text-gray-400 mb-1">ì‹œì²­ ìƒíƒœ</label>
                                <select id="modal-status" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-primary"></select>
                            </div>
                            <div>
                                <label for="modal-score" class="block text-sm font-medium text-gray-400 mb-1">ì ìˆ˜</label>
                                <select id="modal-score" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-primary"></select>
                            </div>
                         </div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-gray-900/50 flex justify-between items-center flex-shrink-0">
                 <button id="modal-delete" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-md transition text-sm">ë¦¬ìŠ¤íŠ¸ì—ì„œ ì‚­ì œ</button>
                 <div class="space-x-3">
                    <button id="modal-cancel" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-md transition">ì·¨ì†Œ</button>
                    <button id="modal-save" class="px-4 py-2 bg-primary hover:bg-blue-700 text-white font-semibold rounded-md transition">ì €ì¥</button>
                 </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithRedirect, getRedirectResult, signOut, signInAnonymously, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        document.addEventListener('DOMContentLoaded', () => {
            const TMDB_API_KEY = '9a5e26536e343678fc2a6147946e748a'; 
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined'
                ? JSON.parse(__firebase_config) : { apiKey: "INVALID_API_KEY", authDomain: "...", projectId: "...", appId: "..." };

            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            let userId = null;
            let userList = {};
            let unsubscribe = null; 
            let currentEditingId = null;
            let currentFilter = 'all';

            // --- UI Elements ---
            const authView = document.getElementById('auth-view');
            const appView = document.getElementById('app');
            // Login
            const loginForm = document.getElementById('login-form');
            const loginEmail = document.getElementById('login-email');
            const loginPassword = document.getElementById('login-password');
            const loginError = document.getElementById('login-error');
            const showSignupBtn = document.getElementById('show-signup');
            // Signup
            const signupForm = document.getElementById('signup-form');
            const signupEmail = document.getElementById('signup-email');
            const signupPassword = document.getElementById('signup-password');
            const signupPasswordConfirm = document.getElementById('signup-password-confirm');
            const signupError = document.getElementById('signup-error');
            const showLoginBtn = document.getElementById('show-login');
            // Social & Guest
            const googleLoginBtn = document.getElementById('google-login-btn');
            const guestLoginBtn = document.getElementById('guest-login-btn');
            // App
            const userProfile = document.getElementById('user-profile');
            const searchInput = document.getElementById('search-input');
            const searchResultsContainer = document.getElementById('search-results');
            const myListContainer = document.getElementById('my-list-container');
            const tabs = document.querySelectorAll('.list-tab');
            // Modal
            const infoModal = document.getElementById('info-modal');
            const modalStatus = document.getElementById('modal-status');
            const modalScore = document.getElementById('modal-score');
            const overviewEl = document.getElementById('info-overview');
            const overviewToggleBtn = document.getElementById('overview-toggle');
            
            const achievements = [
                { level: 1, count: 1, name: "ìƒˆì‹¹", emoji: "ğŸŒ±" },
                { level: 2, count: 30, name: "ì• ë‹ˆ ì• í˜¸ê°€", emoji: "ğŸ§¡" },
                { level: 3, count: 100, name: "ì• ë‹ˆ ì „ë¬¸ê°€", emoji: "ğŸ“" },
                { level: 4, count: 300, name: "ì˜¤íƒ€ì¿ ", emoji: "ğŸ†" },
                { level: 5, count: 500, name: "ë§ë ¹", emoji: "ğŸ‘»" }
            ];

            // --- Authentication ---
            getRedirectResult(auth).catch((error) => console.error("Redirect Error:", error));

            onAuthStateChanged(auth, user => {
                if (user) {
                    userId = user.uid;
                    authView.classList.add('hidden');
                    appView.classList.remove('hidden');
                    userProfile.classList.remove('hidden');
                    
                    if (user.isAnonymous) {
                        userProfile.innerHTML = `<span class="text-sm md:text-base text-yellow-400 font-semibold">ê²ŒìŠ¤íŠ¸ ëª¨ë“œ</span><button id="logout-btn" class="text-xs bg-gray-600 hover:bg-gray-700 text-white font-semibold py-1 px-3 rounded-md transition">ë‚˜ê°€ê¸°</button>`;
                    } else if (user.providerData.some(p => p.providerId === 'google.com')) {
                        userProfile.innerHTML = `<img class="w-8 h-8 md:w-10 md:h-10 rounded-full" src="${user.photoURL}" alt="User Avatar"><span class="text-sm md:text-base text-white font-semibold hidden sm:inline">${user.displayName}</span><button id="logout-btn" class="text-xs bg-gray-600 hover:bg-gray-700 text-white font-semibold py-1 px-3 rounded-md transition">ë¡œê·¸ì•„ì›ƒ</button>`;
                    } else { // Email/Password
                        userProfile.innerHTML = `<span class="text-sm md:text-base text-gray-300 font-medium hidden sm:inline">${user.email}</span><button id="logout-btn" class="text-xs bg-gray-600 hover:bg-gray-700 text-white font-semibold py-1 px-3 rounded-md transition">ë¡œê·¸ì•„ì›ƒ</button>`;
                    }
                    document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
                    loadUserList();
                } else {
                    userId = null;
                    userList = {};
                    if (unsubscribe) unsubscribe();
                    renderMyList(); 
                    updateAchievements();
                    authView.classList.remove('hidden');
                    appView.classList.add('hidden');
                    userProfile.classList.add('hidden');
                }
            });

            async function signInWithGoogle() {
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithRedirect(auth, provider);
                } catch (error) { console.error("Google Sign-in failed:", error); }
            }
            
            async function signInAsGuest() {
                try {
                    await signInAnonymously(auth);
                } catch (error) { console.error("Guest sign-in failed:", error); }
            }
            
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                loginError.classList.add('hidden');
                try {
                    await signInWithEmailAndPassword(auth, loginEmail.value, loginPassword.value);
                } catch (error) {
                    loginError.textContent = getAuthErrorMessage(error.code);
                    loginError.classList.remove('hidden');
                }
            });

            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                signupError.classList.add('hidden');
                if (signupPassword.value !== signupPasswordConfirm.value) {
                    signupError.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
                    signupError.classList.remove('hidden');
                    return;
                }
                try {
                    await createUserWithEmailAndPassword(auth, signupEmail.value, signupPassword.value);
                } catch (error) {
                    signupError.textContent = getAuthErrorMessage(error.code);
                    signupError.classList.remove('hidden');
                }
            });
            
            function getAuthErrorMessage(code) {
                switch (code) {
                    case 'auth/invalid-email': return 'ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤.';
                    case 'auth/user-not-found':
                    case 'auth/wrong-password': return 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                    case 'auth/email-already-in-use': return 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.';
                    case 'auth/weak-password': return 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
                    default: return 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                }
            }
            
            showSignupBtn.addEventListener('click', (e) => { e.preventDefault(); loginForm.classList.add('hidden'); signupForm.classList.remove('hidden'); });
            showLoginBtn.addEventListener('click', (e) => { e.preventDefault(); signupForm.classList.add('hidden'); loginForm.classList.remove('hidden'); });

            // --- The rest of the app's logic (Firestore, TMDB, UI rendering) ---
            function loadUserList() { if (!userId) return; if (unsubscribe) unsubscribe(); const ref = doc(db, `artifacts/${appId}/users/${userId}/animeChecklist`, "data"); unsubscribe = onSnapshot(ref, (d) => { userList = d.exists() ? d.data() : {}; renderMyList(); updateAchievements(); }); }
            async function saveUserList() { if (!userId) return; const ref = doc(db, `artifacts/${appId}/users/${userId}/animeChecklist`, "data"); await setDoc(ref, userList).catch(e => console.error("Save failed:", e)); }
            function debounce(func, delay) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => func.apply(this, a), delay); }; }
            const debouncedSearch = debounce(handleSearchInput, 300);
            async function handleSearchInput() { const q = searchInput.value.trim(); if (q.length < 2) { searchResultsContainer.classList.add('hidden'); return; } searchResultsContainer.innerHTML = `<div class="p-4 text-gray-400">ê²€ìƒ‰ ì¤‘...</div>`; searchResultsContainer.classList.remove('hidden'); try { const res = await fetch(`https://api.themoviedb.org/3/search/tv?api_key=${TMDB_API_KEY}&language=ko-KR&query=${encodeURIComponent(q)}`); if (!res.ok) throw new Error(); const data = await res.json(); const results = data.results.filter(i => i.origin_country.includes('JP') || (i.genre_ids && i.genre_ids.includes(16))); renderSearchResults(results); } catch (e) { searchResultsContainer.innerHTML = `<div class="p-4 text-red-400">ê²€ìƒ‰ ì‹¤íŒ¨</div>`; } }
            function renderSearchResults(results) { if (results.length === 0) { searchResultsContainer.innerHTML = `<div class="p-4 text-gray-400">ê²°ê³¼ ì—†ìŒ</div>`; return; } searchResultsContainer.innerHTML = results.map(a => { const y = a.first_air_date ? a.first_air_date.split('-')[0] : 'N/A'; const p = a.poster_path ? `https://image.tmdb.org/t/p/w92${a.poster_path}` : 'https://placehold.co/45x68/374151/9ca3af?text=N/A'; return `<div class="flex items-center p-3 hover:bg-gray-700 cursor-pointer" data-id="${a.id}" data-title="${encodeURIComponent(a.name)}" data-year="${y}" data-poster="${p}"><img src="${p}" class="w-10 h-15 rounded-sm mr-4"><div><p class="font-semibold text-white">${a.name}</p><p class="text-sm text-gray-300">${y}</p></div></div>`; }).join(''); }
            const statusColors = { watching: { b: 'border-blue-500', g: 'bg-blue-900/30', t: 'text-blue-400' }, completed: { b: 'border-green-500', g: 'bg-green-900/30', t: 'text-green-400' }, planned: { b: 'border-yellow-500', g: 'bg-yellow-900/30', t: 'text-yellow-400' }, dropped: { b: 'border-red-500', g: 'bg-red-900/30', t: 'text-red-400' }, default: { b: 'border-gray-600', g: 'bg-surface', t: 'text-gray-500' } };
            function getFilterName(s) { switch (s) { case 'watching': return 'ì‹œì²­ ì¤‘'; case 'completed': return 'ì™„ë£Œ'; case 'planned': return 'ì‹œì²­ ì˜ˆì •'; case 'dropped': return 'ì¤‘ë‹¨'; case 'all': return 'ì „ì²´'; default: return ''; } }
            function addAnimeToList(data) { const id = data.id; if (!id || userList[id]) return; userList[id] = { id, title: decodeURIComponent(data.title), year: data.year, posterUrl: data.poster, status: 'planned', score: 0, addedAt: Date.now() }; renderMyList(); updateAchievements(); saveUserList(); searchInput.value = ''; searchResultsContainer.classList.add('hidden'); }
            function renderMyList() { const list = Object.entries(userList).filter(([i, d]) => currentFilter === 'all' || d.status === currentFilter).sort(([, a], [, b]) => b.addedAt - a.addedAt); if (list.length === 0) { myListContainer.innerHTML = `<div class="text-center py-10 text-gray-500"><p>${currentFilter === 'all' ? 'ë¦¬ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.' : `'${getFilterName(currentFilter)}' ìƒíƒœì˜ ì• ë‹ˆê°€ ì—†ìŠµë‹ˆë‹¤.`}</p></div>`; return; } myListContainer.innerHTML = list.map(([id, d]) => { const c = statusColors[d.status] || statusColors.default; return `<div class="p-3 rounded-lg flex items-center space-x-4 shadow-md border-l-4 cursor-pointer anime-item ${c.b} ${c.g}" data-id="${id}"><img src="${d.posterUrl}" onerror="this.src='https://placehold.co/45x68/374151/9ca3af?text=N/A'" class="w-10 h-15 rounded-sm shrink-0"><div class="flex-grow min-w-0"><p class="font-bold text-white truncate">${d.title}</p><p class="text-sm text-gray-400">${d.year}</p></div><div class="text-right shrink-0"><p class="font-semibold text-lg ${d.score > 0 ? 'text-primary' : 'text-gray-500'}">${d.score > 0 ? d.score : 'N/A'}</p><p class="text-xs font-semibold ${c.t}">${getFilterName(d.status)}</p></div></div>`; }).join(''); }
            function updateAchievements() { const el = document.getElementById('achievement-details'); if (!el) return; const count = Object.values(userList).filter(i => i.status === 'completed').length; let current = null; for (let i = achievements.length - 1; i >= 0; i--) { if (count >= achievements[i].count) { current = achievements[i]; break; } } const next = achievements.find(a => count < a.count); const display = current || achievements[0]; let text; let target; if (next) { text = `ë‹¤ìŒ: ${next.name} (${count}/${next.count})`; target = next.count; } else { text = 'ìµœê³  ë“±ê¸‰ ë‹¬ì„±!'; target = current ? current.count : 0; } const width = (target > 0) ? Math.min(100, (count / target) * 100) : 0; el.innerHTML = `<div class="flex items-center"><div class="text-3xl mr-4">${display.emoji}</div><div class="flex-grow"><div class="flex justify-between items-baseline"><p class="font-bold text-white">${display.name}</p><p class="text-sm text-gray-400">${text}</p></div><div class="w-full bg-gray-700 rounded-full h-2 mt-1"><div class="progress-bar bg-primary h-2 rounded-full" style="width: ${width}%"></div></div></div></div>`; }
            async function openInfoModal(id) { currentEditingId = id; const anime = userList[id]; if (!anime) return; infoModal.classList.remove('hidden'); document.getElementById('info-loader').classList.remove('hidden'); document.getElementById('info-content-wrapper').classList.add('hidden'); modalStatus.innerHTML = `<option value="watching">ì‹œì²­ ì¤‘</option><option value="completed">ì™„ë£Œ</option><option value="planned">ì‹œì²­ ì˜ˆì •</option><option value="dropped">ì¤‘ë‹¨</option>`; modalScore.innerHTML = `<option value="0">ë¯¸ì„ íƒ</option>${[10,9,8,7,6,5,4,3,2,1].map(s=>`<option value="${s}">${s}</option>`).join('')}`; modalStatus.value = anime.status; modalScore.value = anime.score; try { const res = await fetch(`https://api.themoviedb.org/3/tv/${id}?api_key=${TMDB_API_KEY}&language=ko-KR`); if (!res.ok) throw new Error(); const data = await res.json(); document.getElementById('info-title').textContent = data.name; document.getElementById('info-poster').src = data.poster_path ? `https://image.tmdb.org/t/p/w300${data.poster_path}` : 'https://placehold.co/300x450/374151/9ca3af?text=N/A'; overviewEl.textContent = data.overview || 'ì¤„ê±°ë¦¬ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'; setTimeout(() => { overviewEl.classList.add('overview-truncated'); overviewToggleBtn.classList.toggle('hidden', overviewEl.scrollHeight <= overviewEl.clientHeight); overviewToggleBtn.textContent = 'ë”ë³´ê¸°...'; }, 100); } catch(e) { console.error(e); } finally { document.getElementById('info-loader').classList.add('hidden'); document.getElementById('info-content-wrapper').classList.remove('hidden'); } }
            function closeInfoModal() { infoModal.classList.add('hidden'); }
            function saveChanges() { if (!currentEditingId) return; userList[currentEditingId].status = modalStatus.value; userList[currentEditingId].score = parseInt(modalScore.value, 10); renderMyList(); updateAchievements(); closeInfoModal(); saveUserList(); }
            function deleteItem() { if (!currentEditingId) return; delete userList[currentEditingId]; renderMyList(); updateAchievements(); closeInfoModal(); saveUserList(); }
            
            googleLoginBtn.addEventListener('click', signInWithGoogle);
            guestLoginBtn.addEventListener('click', signInAsGuest);
            searchInput.addEventListener('input', debouncedSearch);
            searchResultsContainer.addEventListener('click', e => { const i = e.target.closest('[data-id]'); if (i) addAnimeToList({ id: i.dataset.id, title: i.dataset.title, year: i.dataset.year, poster: i.dataset.poster }); });
            myListContainer.addEventListener('click', e => { const i = e.target.closest('.anime-item'); if (i) openInfoModal(i.dataset.id); });
            overviewToggleBtn.addEventListener('click', () => { overviewEl.classList.toggle('overview-truncated'); overviewToggleBtn.textContent = overviewEl.classList.contains('overview-truncated') ? 'ë”ë³´ê¸°...' : 'ì ‘ê¸°'; });
            document.getElementById('modal-save').addEventListener('click', saveChanges);
            document.getElementById('modal-cancel').addEventListener('click', closeInfoModal);
            document.getElementById('modal-delete').addEventListener('click', deleteItem);
            tabs.forEach(t => t.addEventListener('click', e => { tabs.forEach(b => b.classList.replace('text-white', 'text-gray-400') || b.classList.replace('border-primary', 'border-transparent')); e.target.classList.replace('text-gray-400', 'text-white'); e.target.classList.replace('border-transparent', 'border-primary'); currentFilter = e.target.dataset.status; renderMyList(); }));
        });
    </script>
</body>
</html>

